<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора - Банк Маннру</title>
    
    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- Material Web Components -->
    <script type="importmap">
        {
            "imports": {
                "@material/web/": "https://esm.run/@material/web/"
            }
        }
    </script>
    <script type="module">
        import '@material/web/all.js';
        import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';
        document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>

    <style>
        body {
            margin: 0;
            padding: 24px;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            min-height: 100vh;
            font-family: 'Roboto', sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .chats-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 80vh;
        }

        .chats-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .chat-item.active {
            background: rgba(103, 80, 164, 0.3);
        }

        .chat-preview {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-window {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .message.support {
            flex-direction: row-reverse;
        }

        .message-content {
            padding: 16px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: white;
            max-width: 70%;
        }

        .support .message-content {
            background: rgba(103, 80, 164, 0.3);
        }

        .message-time {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .reply-form {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
        }

        md-outlined-text-field {
            flex: 1;
            --md-outlined-text-field-container-color: rgba(255, 255, 255, 0.1);
            --md-outlined-text-field-label-text-color: rgba(255, 255, 255, 0.8);
            --md-outlined-text-field-input-text-color: white;
        }

        .priority-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .header {
            color: white;
            margin-bottom: 24px;
        }

        .unread-badge {
            background: #f44336;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        .loading {
            color: white;
            padding: 16px;
            text-align: center;
            font-style: italic;
        }

        .chat-item.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .error-message {
            color: #ffcdd2;
            font-size: 12px;
        }

        #connection-status {
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Индикатор загрузки */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Статус подключения */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Панель администратора</h1>
            <md-filled-button id="refresh-button" onclick="window.location.reload()">
                Обновить соединение
                <span slot="icon" class="material-symbols-outlined">refresh</span>
            </md-filled-button>
            <div style="margin-top: 8px;">
                Статус подключения: <span id="connection-status">Проверка...</span>
            </div>
        </div>

        <div class="chats-container">
            <div class="chats-list" id="chats-list">
                <div class="loading">Загрузка чатов...</div>
            </div>

            <div class="chat-window">
                <div class="messages" id="messages">
                    <!-- Сообщения будут добавлены здесь -->
                </div>

                <form id="reply-form" class="reply-form">
                    <div style="flex: 1;">
                        <div class="priority-selector">
                            <md-filled-tonal-button id="low-priority" onclick="setPriority('low')">
                                Низкий
                            </md-filled-tonal-button>
                            <md-filled-tonal-button id="medium-priority" onclick="setPriority('medium')">
                                Средний
                            </md-filled-tonal-button>
                            <md-filled-tonal-button id="high-priority" onclick="setPriority('high')">
                                Высокий
                            </md-filled-tonal-button>
                        </div>
                        <md-outlined-text-field
                            type="text"
                            label="Ответ пользователю"
                            id="reply-input"
                            required>
                        </md-outlined-text-field>
                    </div>
                    <md-filled-button type="submit">
                        Отправить
                        <span slot="icon" class="material-symbols-outlined">send</span>
                    </md-filled-button>
                </form>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <!-- Добавляем панель мониторинга -->
        <div class="monitoring-panel">
            <div class="stat-card">
                <span id="online-users">0</span>
                <span>Онлайн</span>
            </div>
            <div class="stat-card">
                <span id="pending-tickets">0</span>
                <span>Ожидают</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { database } from './firebase-config.js';
        import { ref, push, onValue, get, getDatabase, connectDatabaseEmulator } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Проверяем подключение к базе данных
        function checkDatabaseConnection() {
            const connectedRef = ref(database, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    console.log('Подключено к Firebase');
                    document.getElementById('connection-status').textContent = 'Подключено';
                    document.getElementById('connection-status').style.color = '#4caf50';
                } else {
                    console.log('Отключено от Firebase');
                    document.getElementById('connection-status').textContent = 'Отключено';
                    document.getElementById('connection-status').style.color = '#f44336';
                }
            });
        }

        // Добавляем индикатор состояния подключения
        const header = document.querySelector('.header');
        header.insertAdjacentHTML('beforeend', `
            <div style="margin-top: 8px;">
                Статус подключения: <span id="connection-status">Проверка...</span>
            </div>
        `);

        checkDatabaseConnection();

        let currentChatId = null;
        let selectedPriority = 'low';

        // Функция установки приоритета
        window.setPriority = function(priority) {
            selectedPriority = priority;
            document.querySelectorAll('.priority-selector md-filled-tonal-button').forEach(btn => {
                btn.style.background = btn.id === `${priority}-priority` ? 'rgba(103, 80, 164, 0.3)' : '';
            });
        };

        // Функция для повторной попытки получения данных
        async function retryGet(ref, maxAttempts = 3) {
            let attempt = 0;
            while (attempt < maxAttempts) {
                try {
                    const snapshot = await get(ref);
                    return snapshot;
                } catch (error) {
                    attempt++;
                    console.log(`Попытка ${attempt} не удалась, ожидание...`);
                    if (attempt === maxAttempts) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        // Слушаем все чаты с обработкой ошибок
        const chatsRef = ref(database, 'support_chats');
        onValue(chatsRef, 
            async (snapshot) => {
                console.log('Получены данные чатов:', snapshot.val());
                const chatsList = document.getElementById('chats-list');
                chatsList.innerHTML = '';
                
                if (snapshot.exists()) {
                    const chats = snapshot.val();
                    for (const [cardId, chat] of Object.entries(chats)) {
                        try {
                            const cardRef = ref(database, `cards/${cardId}`);
                            const cardSnapshot = await retryGet(cardRef);
                            console.log('Данные карты:', cardId, cardSnapshot.val());
                            
                            if (!cardSnapshot.exists()) {
                                console.log('Карта не найдена:', cardId);
                                continue;
                            }

                            const cardData = cardSnapshot.val();
                            
                            const lastMessage = chat.messages ? 
                                Object.values(chat.messages).sort((a, b) => b.timestamp - a.timestamp)[0] : 
                                null;

                            console.log('Последнее сообщение:', lastMessage);

                            const chatItem = document.createElement('div');
                            chatItem.className = `chat-item ${cardId === currentChatId ? 'active' : ''}`;
                            chatItem.innerHTML = `
                                <div>Карта: ${cardData.number}</div>
                                <div class="chat-preview">
                                    ${lastMessage ? lastMessage.text : 'Нет сообщений'}
                                </div>
                            `;
                            
                            chatItem.onclick = () => {
                                currentChatId = cardId;
                                document.querySelectorAll('.chat-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                chatItem.classList.add('active');
                                loadMessages(cardId);
                            };
                            
                            chatsList.appendChild(chatItem);
                        } catch (error) {
                            console.error('Ошибка при обработке чата:', cardId, error);
                            // Показываем ошибку в интерфейсе
                            const errorItem = document.createElement('div');
                            errorItem.className = 'chat-item error';
                            errorItem.innerHTML = `
                                <div>Ошибка загрузки чата ${cardId}</div>
                                <div class="chat-preview error-message">
                                    ${error.message}
                                </div>
                            `;
                            chatsList.appendChild(errorItem);
                        }
                    }
                } else {
                    console.log('Нет активных чатов');
                    chatsList.innerHTML = '<div style="color: white; padding: 16px;">Нет активных чатов</div>';
                }
            },
            (error) => {
                console.error('Ошибка при получении чатов:', error);
                const chatsList = document.getElementById('chats-list');
                chatsList.innerHTML = `
                    <div class="chat-item error">
                        <div>Ошибка загрузки чатов</div>
                        <div class="chat-preview error-message">
                            ${error.message}
                        </div>
                        <md-filled-button onclick="window.location.reload()">
                            Повторить попытку
                        </md-filled-button>
                    </div>
                `;
            }
        );

        function loadMessages(cardId) {
            const messagesRef = ref(database, `support_chats/${cardId}/messages`);
            onValue(messagesRef, (snapshot) => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    Object.entries(messages).forEach(([id, msg]) => {
                        const messageEl = document.createElement('div');
                        messageEl.className = `message ${msg.from === 'support' ? 'support' : 'user'}`;
                        
                        let priorityBadge = '';
                        if (msg.priority) {
                            priorityBadge = `
                                <div class="priority-badge priority-${msg.priority}">
                                    ${msg.priority.charAt(0).toUpperCase() + msg.priority.slice(1)} Priority
                                </div>
                            `;
                        }

                        messageEl.innerHTML = `
                            <div class="message-content">
                                ${priorityBadge}
                                <div>${msg.text}</div>
                                <div class="message-time">
                                    ${new Date(msg.timestamp).toLocaleString()}
                                </div>
                            </div>
                        `;
                        messagesDiv.appendChild(messageEl);
                    });
                    
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            });
        }

        // Отправка ответа
        document.getElementById('reply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentChatId) {
                alert('Выберите чат для ответа');
                return;
            }

            const text = document.getElementById('reply-input').value.trim();
            if (!text) return;

            try {
                const messagesRef = ref(database, `support_chats/${currentChatId}/messages`);
                await push(messagesRef, {
                    text,
                    from: 'support',
                    timestamp: Date.now(),
                    priority: selectedPriority,
                    status: 'sent'
                });

                document.getElementById('reply-input').value = '';
            } catch (error) {
                console.error('Error sending reply:', error);
                alert('Ошибка при отправке ответа');
            }
        });

        // Устанавливаем низкий приоритет по умолчанию
        setPriority('low');

        // Добавляем статус подключения
        const connectionStatus = document.createElement('div');
        connectionStatus.className = 'connection-status';
        document.body.appendChild(connectionStatus);

        // Функция обновления статуса
        function updateConnectionStatus(isConnected) {
            connectionStatus.innerHTML = `
                <span class="status-dot ${isConnected ? 'connected' : 'disconnected'}"></span>
                ${isConnected ? 'Подключено' : 'Отключено'}
            `;
        }

        // Добавляем поиск по чатам
        const searchInput = document.createElement('md-outlined-text-field');
        searchInput.label = 'Поиск чатов';
        searchInput.type = 'search';
        document.querySelector('.chats-list').prepend(searchInput);

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'block' : 'none';
            });
        });

        // Функция мониторинга активности
        function monitorActivity() {
            const now = Date.now();
            document.querySelectorAll('.chat-item').forEach(chat => {
                const lastActivity = parseInt(chat.dataset.lastActivity);
                if (now - lastActivity > 300000) { // 5 минут
                    chat.classList.add('inactive');
                }
            });
        }

        // Функция массового ответа
        async function bulkReply(message) {
            const selectedChats = Array.from(document.querySelectorAll('.chat-item.selected'));
            for (const chat of selectedChats) {
                await sendMessage(chat.dataset.chatId, message);
            }
        }

        // Обновление статистики каждую минуту
        setInterval(monitorActivity, 60000);
    </script>
</body>
</html>