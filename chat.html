<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Беседка - Уютный чат</title>
    
    <!-- Material Design Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    
    <!-- Material Web Components -->
    <script type="importmap">
        {
            "imports": {
                "@material/web/": "https://esm.run/@material/web/"
            }
        }
    </script>
    <script type="module">
        import '@material/web/all.js';
        import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

        // Дождемся загрузки компонентов
        window.addEventListener('load', () => {
            document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
        });
    </script>
    
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">

    <!-- Добавляем необходимые стили -->
    <style>
        /* Стили для медиа-элементов */
        .media-preview {
            max-width: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .voice-message {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            cursor: pointer;
        }
        
        .server-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .chat-layout {
            display: flex;
            height: calc(100vh - 64px);
            gap: 20px;
            padding: 20px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            height: 100%;
        }

        .chat-toolbar {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 8px;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 0;
            background: rgba(255, 255, 255, 0.02);
        }

        .messages-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .message-date-divider {
            text-align: center;
            color: var(--md-sys-color-outline);
            font-size: 0.9em;
            margin: 16px 0 8px;
            position: sticky;
            top: 0;
            background: inherit;
            padding: 4px;
            z-index: 1;
        }

        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            margin: 1px 0;
            word-break: break-word;
        }

        .message.sent {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            margin-left: auto;
        }

        .message.received {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            margin-right: auto;
        }

        .message-wrapper {
            position: relative;
            width: 100%;
        }

        .message-info {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 0.7em;
            opacity: 0.5;
            margin-top: 4px;
            text-align: right;
        }

        .input-area {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-area form {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .media-buttons {
            display: flex;
            gap: 4px;
        }

        md-filled-text-field {
            flex: 1;
        }

        .new-messages-indicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="light-theme">
    <nav>
        <div class="nav-content">
            <h1 class="headline-large">Беседка</h1>
            <div class="nav-actions">
                <md-icon-button id="admin-button">
                    <md-icon>admin_panel_settings</md-icon>
                </md-icon-button>
                <md-icon-button id="theme-toggle">
                    <md-icon>dark_mode</md-icon>
                </md-icon-button>
                <md-icon-button id="settings-button">
                    <md-icon>settings</md-icon>
                </md-icon-button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="chat-layout">
            <!-- Список пользователей -->
            <div class="users-sidebar">
                <div class="users-header">
                    <h2 class="title-medium">Пользователи онлайн</h2>
                </div>
                <div id="users-list" class="users-list"></div>
            </div>
            
            <div class="chat-container">
                <div class="chat-toolbar">
                    <md-filled-button id="clear-chat">
                        <md-icon slot="icon">clear_all</md-icon>
                        Очистить чат
                    </md-filled-button>
                    <md-filled-button id="download-chat">
                        <md-icon slot="icon">download</md-icon>
                        Скачать историю
                    </md-filled-button>
                </div>
                <div id="messages" class="messages-area"></div>
                
                <div class="input-area">
                    <form onsubmit="return false;">
                        <div class="media-buttons">
                            <md-icon-button id="voice-button">
                                <md-icon>mic</md-icon>
                            </md-icon-button>
                            <md-icon-button id="video-button">
                                <md-icon>videocam</md-icon>
                            </md-icon-button>
                            <md-icon-button id="attach-button">
                                <md-icon>add_photo_alternate</md-icon>
                            </md-icon-button>
                        </div>
                        <md-filled-text-field
                            id="message-input"
                            type="text"
                            placeholder="Введите сообщение..."
                        ></md-filled-text-field>
                        <md-icon-button id="send-button">
                            <md-icon>send</md-icon>
                        </md-icon-button>
                    </form>
                    <input type="file" id="file-input" accept="image/*,video/*" style="display: none">
                    <audio id="voice-recorder" style="display: none"></audio>
                </div>
                <div id="buyButtonContainer" style="display: none; padding: 16px; text-align: center;">
                    <md-filled-button id="buyButton">
                        <md-icon slot="icon">shopping_cart</md-icon>
                        Купить товар
                    </md-filled-button>
                </div>
            </div>
        </div>
    </div>

    <!-- Диалог входа -->
    <md-dialog id="login-dialog" class="login-dialog" modal>
        <div slot="headline" class="headline-small">Добро пожаловать в Беседку</div>
        <form slot="content" method="dialog" class="login-form">
            <md-outlined-text-field
                id="username-input"
                label="Ваше имя"
                required
                minlength="2"
                supporting-text="Как вас будут видеть другие участники"
            ></md-outlined-text-field>
            <md-filled-button id="start-chat-btn" disabled>
                Начать общение
            </md-filled-button>
        </form>
    </md-dialog>

    <!-- Диалог настроек -->
    <md-dialog id="settings-dialog">
        <div slot="headline" class="headline-small">Настройки</div>
        <div slot="content">
            <div class="setting-item">
                <div class="setting-info">
                    <span class="title-medium">Тёмная тема</span>
                    <span class="body-medium">Включить тёмное оформление</span>
                </div>
                <md-switch id="theme-switch"></md-switch>
            </div>

            <div class="setting-item">
                <div class="setting-info">
                    <span class="title-medium">Размер шрифта</span>
                    <span class="body-medium">Масштаб текста сообщений</span>
                </div>
                <div class="font-size-controls">
                    <md-icon-button id="decrease-font">
                        <md-icon>text_decrease</md-icon>
                    </md-icon-button>
                    <span id="font-size-value" class="body-large">100%</span>
                    <md-icon-button id="increase-font">
                        <md-icon>text_increase</md-icon>
                    </md-icon-button>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-info">
                    <span class="title-medium">Изменить имя</span>
                    <span class="body-medium">Как вас будут видеть другие</span>
                </div>
                <div class="nickname-input">
                    <md-outlined-text-field
                        id="nickname-input"
                        label="Ваше имя"
                    ></md-outlined-text-field>
                    <md-icon-button id="save-nickname">
                        <md-icon>save</md-icon>
                    </md-icon-button>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-info">
                    <span class="title-medium">Очистить историю</span>
                    <span class="body-medium">Очистить локальную историю чата</span>
                </div>
                <md-filled-tonal-button id="clear-history" class="error">
                    <md-icon slot="icon">delete</md-icon>
                    Очистить
                </md-filled-tonal-button>
            </div>
        </div>
        <div slot="actions">
            <md-text-button dialog-action="close">
                Закрыть
            </md-text-button>
        </div>
    </md-dialog>

    <style>
        .chat-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: calc(100vh - 80px);
        }

        .users-sidebar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .users-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }

        @media (max-width: 768px) {
            .chat-layout {
                grid-template-columns: 1fr;
            }

            .users-sidebar {
                display: none;
            }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref as dbRef, push, onChildAdded, onValue, remove, set, get, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        
        // DOM элементы
        const messagesArea = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const fileInput = document.getElementById('file-input');
        const attachButton = document.getElementById('attach-button');
        
        // DOM элементы для входа
        const loginDialog = document.getElementById('login-dialog');
        const usernameInput = document.getElementById('username-input');
        const startChatBtn = document.getElementById('start-chat-btn');

        // DOM элементы для настроек
        const themeToggle = document.getElementById('theme-toggle');
        const settingsButton = document.getElementById('settings-button');
        const settingsDialog = document.getElementById('settings-dialog');
        const closeSettings = document.getElementById('close-settings');
        const themeSwitch = document.getElementById('theme-switch');
        const decreaseFontBtn = document.getElementById('decrease-font');
        const increaseFontBtn = document.getElementById('increase-font');
        const fontSizeValue = document.getElementById('font-size-value');
        const nicknameInput = document.getElementById('nickname-input');
        const saveNicknameBtn = document.getElementById('save-nickname');
        const clearHistoryBtn = document.getElementById('clear-history');

        // DOM элементы
        const adminButton = document.getElementById('admin-button');

        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBoT-HND1o56AJlpbqfEV3iMLR5YnK8fVg",
            authDomain: "besedka-chat.firebaseapp.com",
            databaseURL: "https://besedka-chat-default-rtdb.firebaseio.com",
            projectId: "besedka-chat",
            messagingSenderId: "751408360344",
            appId: "1:751408360344:web:fa0c11530b270184c499ed",
            measurementId: "G-M075LD8008"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Генерация случайного ID пользователя
        let userId;

        // Загрузка сохранённых настроек
        const savedTheme = localStorage.getItem('theme') || 'light';
        const savedFontSize = localStorage.getItem('font-size') || 100;
        let username = localStorage.getItem('username');

        // Применяем сохранённые настройки
        document.body.className = `${savedTheme}-theme`;
        themeSwitch.checked = savedTheme === 'dark';
        fontSizeValue.textContent = `${savedFontSize}%`;
        document.documentElement.style.setProperty('--message-font-size', `${savedFontSize}%`);

        // Обновляем состояние всех Material компонентов после загрузки
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('md-*').forEach(element => {
                if (element.updateComplete) {
                    element.updateComplete.then(() => element.requestUpdate());
                }
            });
        });

        // Дождемся загрузки DOM и компонентов
        window.addEventListener('load', () => {
            const loginDialog = document.querySelector('md-dialog#login-dialog');
            if (loginDialog) {
                loginDialog.show();
            }
        });

        // Проверяем, вошел ли пользователь
        if (!username) {
            // Активируем кнопку только если имя введено
            usernameInput.addEventListener('input', () => {
                startChatBtn.disabled = !usernameInput.value.trim();
            });

            // Обработка входа
            startChatBtn.addEventListener('click', async () => {
                username = usernameInput.value.trim();
                if (username) {
                    // Проверяем, существует ли пользователь с таким именем
                    const usersRef = dbRef(database, 'users');
                    const snapshot = await get(usersRef);
                    let existingUser = null;
                    
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        if (user.username === username) {
                            existingUser = user;
                        }
                    });
                    
                    if (existingUser) {
                        userId = existingUser.userId;
                    } else {
                        userId = 'user_' + username.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    }
                    
                    localStorage.setItem('username', username);
                    localStorage.setItem('userId', userId);
                    loginDialog.close();
                    initChat();
                }
            });
        } else {
            // Восстанавливаем userId из localStorage или генерируем новый
            userId = localStorage.getItem('userId') || 'user_' + username.toLowerCase().replace(/[^a-z0-9]/g, '_');
            initChat();
        }

        // Функция инициализации чата
        async function initChat() {
            // Регистрируем пользователя
            registerUser();

            // Создаем ссылку на сообщения один раз
            const messagesRef = dbRef(database, 'messages');

            // Обновляем отправку сообщения, добавляя имя пользователя
            function sendMessage() {
                const text = messageInput.value.trim();
                if (text.length === 0) return;

                const message = {
                    type: 'text',
                    text: text,
                    userId: userId,
                    username: username,
                    timestamp: Date.now()
                };

                push(messagesRef, message);
                messageInput.value = '';
            }

            // Обновляем отображение сообщений
            let currentDate = null;
            let currentGroup = null;

            onChildAdded(messagesRef, (snapshot) => {
                const message = snapshot.val();
                const messageDate = new Date(message.timestamp).toLocaleDateString();
                
                // Создаем новую группу для новой даты
                if (messageDate !== currentDate) {
                    currentDate = messageDate;
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'message-date-divider';
                    dateDivider.textContent = messageDate;
                    
                    currentGroup = document.createElement('div');
                    currentGroup.className = 'messages-group';
                    
                    messagesArea.appendChild(dateDivider);
                    messagesArea.appendChild(currentGroup);
                }

                const messageElement = document.createElement('div');
                const isOwnMessage = message.userId === userId;
                
                messageElement.className = `message ${isOwnMessage ? 'sent' : 'received'}`;
                
                if (message.type === 'image') {
                    messageElement.innerHTML = `
                        <div class="message-info">${message.username || 'Пользователь'}</div>
                        <div class="message-image">
                            <img src="${message.imageData}" alt="Изображение" loading="lazy">
                        </div>
                        <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <div class="message-info">${message.username || 'Пользователь'}</div>
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
                    `;
                }
                
                currentGroup.appendChild(messageElement);
                
                // Проверяем, нужно ли прокручивать
                const shouldScroll = messagesArea.scrollTop + messagesArea.clientHeight >= messagesArea.scrollHeight - 100;
                
                if (shouldScroll || isOwnMessage) {
                    setTimeout(() => {
                        messageElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }, 100);
                } else {
                    showNewMessageIndicator();
                }
            });

            // Индикатор новых сообщений
            const newMessageIndicator = document.createElement('div');
            newMessageIndicator.className = 'new-messages-indicator';
            newMessageIndicator.textContent = 'Новые сообщения';
            newMessageIndicator.onclick = () => {
                messagesArea.lastElementChild?.scrollIntoView({ behavior: 'smooth', block: 'end' });
                newMessageIndicator.style.display = 'none';
            };
            document.body.appendChild(newMessageIndicator);

            function showNewMessageIndicator() {
                newMessageIndicator.style.display = 'block';
                setTimeout(() => {
                    newMessageIndicator.style.display = 'none';
                }, 3000);
            }

            // Следим за прокруткой
            messagesArea.addEventListener('scroll', () => {
                if (messagesArea.scrollTop + messagesArea.clientHeight >= messagesArea.scrollHeight - 20) {
                    newMessageIndicator.style.display = 'none';
                }
            });

            // Обновляем поле никнейма в настройках
            nicknameInput.value = username;

            // Слушатели событий для текстовых сообщений
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Обработка загрузки изображений
            attachButton.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Проверяем размер файла (максимум 1MB)
                if (file.size > 1 * 1024 * 1024) {
                    alert('Файл слишком большой. Максимальный размер: 1MB');
                    fileInput.value = '';
                    return;
                }

                try {
                    // Показываем индикатор загрузки
                    const loadingMessage = document.createElement('div');
                    loadingMessage.className = 'message sent';
                    loadingMessage.innerHTML = `
                        <div class="message-text">Загрузка изображения...</div>
                    `;
                    messagesArea.appendChild(loadingMessage);
                    messagesArea.scrollTop = messagesArea.scrollHeight;

                    // Конвертируем изображение в base64
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64Image = e.target.result;
                        
                        // Создаем сообщение с изображением
                        const message = {
                            type: 'image',
                            imageData: base64Image,
                            userId: userId,
                            username: username, // Добавляем имя пользователя
                            timestamp: Date.now()
                        };

                        const messagesRef = dbRef(database, 'messages');
                        await push(messagesRef, message);
                        
                        // Удаляем сообщение о загрузке
                        messagesArea.removeChild(loadingMessage);
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Ошибка при загрузке изображения: ' + error.message);
                }

                fileInput.value = '';
            });

            // Добавляем обновление списка пользователей
            updateOnlineUsers();
        }

        // Обработчики настроек
        themeToggle.addEventListener('click', toggleTheme);
        themeSwitch.addEventListener('change', toggleTheme);
        settingsButton.addEventListener('click', async () => {
            const dialog = document.getElementById('settings-dialog');
            await dialog.updateComplete;
            dialog.show();
        });

        // Добавим обработчик для кнопки закрытия
        document.querySelector('[dialog-action="close"]').addEventListener('click', async () => {
            const dialog = document.getElementById('settings-dialog');
            await dialog.updateComplete;
            dialog.close();
        });

        // Обработчик изменения никнейма
        saveNicknameBtn.addEventListener('click', () => {
            const newUsername = nicknameInput.value.trim();
            if (newUsername) {
                username = newUsername;
                localStorage.setItem('username', username);
                alert('Имя успешно изменено!');
            }
        });

        // Функция переключения темы
        function toggleTheme() {
            const isDark = document.body.classList.contains('dark-theme');
            document.body.className = isDark ? 'light-theme' : 'dark-theme';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            themeSwitch.checked = !isDark;
            
            // Обновляем состояние всех Material компонентов
            requestAnimationFrame(() => {
                document.querySelectorAll('[md-]').forEach(element => {
                    if (element.updateComplete) {
                        element.updateComplete.then(() => element.requestUpdate());
                    }
                });
            });
        }

        function updateOnlineUsers() {
            const usersRef = dbRef(database, 'users');
            const usersList = document.getElementById('users-list');
            
            onChildAdded(usersRef, (snapshot) => {
                const user = snapshot.val();
                if (user.userId !== userId) {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.innerHTML = `
                        <div class="user-info">
                            <div class="user-status"></div>
                            <span>${user.username}</span>
                        </div>
                        <md-icon-button onclick="startPrivateChat('${user.userId}', '${user.username}')">
                            <md-icon>chat</md-icon>
                        </md-icon-button>
                    `;
                    usersList.appendChild(userElement);
                }
            });

            // Удаляем пользователей, которые вышли
            onChildRemoved(usersRef, (snapshot) => {
                const userId = snapshot.val().userId;
                const userElement = usersList.querySelector(`[data-user-id="${userId}"]`);
                if (userElement) {
                    userElement.remove();
                }
            });
        }

        // Обновляем функцию startPrivateChat
        window.startPrivateChat = (targetUserId, targetUsername) => {
            const dialog = document.createElement('md-dialog');
            dialog.innerHTML = `
                <div slot="headline">Чат с ${targetUsername}</div>
                <div slot="content" class="private-chat-content">
                    <div class="private-messages" id="private-messages-${targetUserId}"></div>
                    <div class="input-area">
                        <md-filled-text-field
                            id="private-message-input-${targetUserId}"
                            type="text"
                            placeholder="Введите сообщение..."
                        ></md-filled-text-field>
                        <md-icon-button id="private-send-${targetUserId}">
                            <md-icon>send</md-icon>
                        </md-icon-button>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);
            dialog.show();

            const messagesDiv = dialog.querySelector(`#private-messages-${targetUserId}`);
            const input = dialog.querySelector(`#private-message-input-${targetUserId}`);
            const sendButton = dialog.querySelector(`#private-send-${targetUserId}`);

            // Загружаем историю сообщений
            const chatId = [userId, targetUserId].sort().join('_');
            const chatRef = dbRef(database, `private_chats/${chatId}`);

            onChildAdded(chatRef, (snapshot) => {
                const message = snapshot.val();
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.userId === userId ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-content">${message.text}</div>
                    <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
                `;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });

            // Отправка сообщений
            const sendMessage = () => {
                const text = input.value.trim();
                if (text) {
                    push(chatRef, {
                        text,
                        userId,
                        username,
                        timestamp: Date.now()
                    });
                    input.value = '';
                }
            };

            sendButton.addEventListener('click', sendMessage);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        };

        // Добавляем пользователя в список при входе
        function registerUser() {
            const userRef = dbRef(database, `users/${userId}`);
            set(userRef, {
                userId,
                username,
                lastSeen: Date.now()
            });

            // Удаляем пользователя при закрытии страницы
            window.addEventListener('beforeunload', () => {
                remove(userRef);
            });
        }

        // Обработчик кнопки админ-панели
        adminButton.addEventListener('click', () => {
            window.location.href = 'admin.html';
        });

        // Функция для записи голосовых сообщений
        let mediaRecorder = null;
        let audioChunks = [];

        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Отправляем голосовое сообщение
                    await sendMessage({
                        type: 'voice',
                        url: audioUrl,
                        duration: Math.round(audioChunks.length / 100) // Примерная длительность
                    });
                };

                mediaRecorder.start();
                document.getElementById('voice-button').innerHTML = '<md-icon>stop</md-icon>';
            } catch (error) {
                console.error('Error starting voice recording:', error);
                showNotification('Ошибка при записи голоса', true);
            }
        }

        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('voice-button').innerHTML = '<md-icon>mic</md-icon>';
            }
        }

        // Обработчик видео
        document.getElementById('video-button').addEventListener('click', () => {
            const input = document.getElementById('file-input');
            input.accept = 'video/*';
            input.click();
        });

        // Обработчик голосовых сообщений
        document.getElementById('voice-button').addEventListener('click', () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                startVoiceRecording();
            } else {
                stopVoiceRecording();
            }
        });

        // Автоматическое создание сервера при первом сообщении
        async function createServerIfNeeded() {
            const serverRef = dbRef(database, 'servers/default');
            const snapshot = await get(serverRef);
            
            if (!snapshot.exists()) {
                await set(serverRef, {
                    name: 'Основной сервер',
                    created: serverTimestamp(),
                    members: {}
                });
            }
        }

        // Модифицируем функцию отправки сообщений
        async function sendMessage(content) {
            try {
                await createServerIfNeeded();
                const messagesRef = dbRef(database, 'servers/default/messages');
                await push(messagesRef, {
                    content,
                    userId,
                    username,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Ошибка при отправке сообщения', true);
            }
        }

        // Обновляем обработчик файлов
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const dataUrl = e.target.result;
                        await sendMessage({
                            type: file.type.startsWith('video/') ? 'video' : 'image',
                            url: dataUrl,
                            name: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error handling file:', error);
                    showNotification('Ошибка при обработке файла', true);
                }
            }
        });

        // Функция скачивания истории чата
        async function downloadChatHistory() {
            const messages = Array.from(document.querySelectorAll('.message'))
                .map(msg => msg.textContent)
                .join('\n');
            const blob = new Blob([messages], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat-history.txt';
            a.click();
        }

        // Функция очистки чата
        function clearChat() {
            if (confirm('Очистить историю чата?')) {
                document.getElementById('messages').innerHTML = '';
            }
        }

        // Добавляем обработчики
        document.getElementById('download-chat').onclick = downloadChatHistory;
        document.getElementById('clear-chat').onclick = clearChat;

        document.addEventListener('DOMContentLoaded', () => {
            // Получаем параметры из URL
            const urlParams = new URLSearchParams(window.location.search);
            const recipientId = urlParams.get('recipientId');
            const productId = urlParams.get('productId');
            const price = Number(urlParams.get('price'));
            const showBuyButton = urlParams.get('showBuyButton') === 'true';
            
            // Показываем кнопку покупки если это чат о товаре
            if (showBuyButton && productId && price) {
                const buyButtonContainer = document.getElementById('buyButtonContainer');
                const buyButton = document.getElementById('buyButton');
                buyButtonContainer.style.display = 'block';
                
                buyButton.addEventListener('click', async () => {
                    try {
                        const buyerId = localStorage.getItem('currentCardId');
                        if (!buyerId) {
                            throw new Error('Необходимо войти в аккаунт');
                        }
                        
                        // Проверяем баланс покупателя
                        const buyerRef = dbRef(database, `cards/${buyerId}`);
                        const buyerSnapshot = await get(buyerRef);
                        const buyer = buyerSnapshot.val();
                        
                        if (!buyer || buyer.balance < price) {
                            throw new Error('Недостаточно средств');
                        }
                        
                        // Переводим деньги продавцу
                        const sellerRef = dbRef(database, `cards/${recipientId}`);
                        const sellerSnapshot = await get(sellerRef);
                        const seller = sellerSnapshot.val();
                        
                        if (!seller) {
                            throw new Error('Продавец не найден');
                        }
                        
                        // Обновляем балансы
                        await set(dbRef(database, `cards/${buyerId}/balance`), buyer.balance - price);
                        await set(dbRef(database, `cards/${recipientId}/balance`), (seller.balance || 0) + price);
                        await set(dbRef(database, `cards/${buyerId}/transactions/${Date.now()}`), {
                            type: 'purchase',
                            amount: -price,
                            description: 'Покупка пользовательского товара',
                            timestamp: Date.now()
                        });
                        await set(dbRef(database, `cards/${recipientId}/transactions/${Date.now()}`), {
                            type: 'sale',
                            amount: price,
                            description: 'Продажа пользовательского товара',
                            timestamp: Date.now()
                        });
                        
                        alert('Товар успешно куплен!');
                        buyButtonContainer.style.display = 'none';
                    } catch (error) {
                        console.error('Ошибка при покупке:', error);
                        alert(error.message);
                    }
                });
            }
        });
    </script>
</body>
</html>

